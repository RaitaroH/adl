#!/bin/bash
# version: 1.9
# Wrapper for anime-donwloader. Allows using watchlist given by trackma for a better anime watching cli experience.

tlist=$(trackma list | sed 's/\x1b\[[0-9;]*m//g ; s/^[^A-Za-z]* //g' | head -n -2 |\
  awk -F'  ' 'NR>1 {split($1,t,"."); gsub(" ", "", $2)split($2,n,"/"); print t[1]"|"n[1]"|"n[2]}')
# Explination ...
# sed is removing color formating and everything untill the first letter it finds
# head is used here to remove the last 2 lines which are also not needed
# NR>1 ignore first line which is the header
# $1 is the title plus dots ... split allows to remove the dots, sets new result to var t
# $2 is Current / All episodes split allows to get the current episode number
# gsub thingy is to remove beggining space " 2" from one digit numbers
# finally print t[1] = title and n[1] current episode number: result is like so:    Animu|x

watching_prompt() { echo "Now watching \033[0;34m$1\033[0m, $2 \033[0;34m$3 \033[0m" ;}
color_prompt() { echo "\033[0;36m$@ \033[0m" ;}
# for better readability $title and $nr will be blue
# You can find other colors here: https://stackoverflow.com/questions/5947742/how-to-change-the-output-color-of-echo-in-linux

watch() {
  # Retrieve title and nr. cat file only once
  entry="$(echo $tlist | fzf --height=15% --tac -m)"
  title="$(echo $entry | cut -d'|' -f1)"
  nr="$(($(echo $entry | cut -d'|' -f2) + 1))" #dat spacing tho
  last="$(echo $entry | cut -d'|' -f3)"

  color_prompt "Enter lowercase or uppercase to issue command:
    N - next episode (default, press <ENTER>)
    L - from current to Last known
    A - All available, from episode 1
    R - Rewatch current episode only
    S - Skip the watching. Straight to list update."
  printf "\033[0;34mYour choice? [N/l/a/r/s] "
  read ans_episode
  echo
  case $ans_episode in
    ""|"n"|"N")
      watching_prompt $title "episode" "#$nr"
      anime dl --play vlc $title --episodes $nr 2> /dev/null ;;
    "l"|"L")
      watching_prompt $title "starting with episode" "#$nr"
      anime dl --play vlc $title --episodes $nr:$last 2> /dev/null ;;
    "a"|"A")
      watching_prompt $title "starting with episode" "#1"
      anime dl --play vlc $title 2> /dev/null ;;
    "r"|"R")
      watching_prompt $title "episode" "#$(($nr - 1))"
      anime dl --play vlc $title --episodes $(($nr - 1)) 2> /dev/null ;;
    "s"|"S")
      color_prompt "Skipping watching episodes."
      color_prompt "Enter custom number:"
      read custom
      trackma update $title $custom
      trackma send
      exit 1 ;;
  esac

  color_prompt "\nIf vlc didn't start, the anime wasn't found"
  color_prompt "Increase nr in anime list? Yes, no, or custom number [Y/n/c]"
  read ans_update
  case $ans_update in
    ""|"y"|"Y")
      trackma update $title $nr
      trackma send ;;
    "n"|"N")
      color_prompt "Exiting." ;;
    "c"|"C")
      color_prompt "Enter custom number:"
      read custom
      trackma update $title $custom
      trackma send ;;
  esac
} #end of watch()

watch #initial call

while true; do #run as many episodes as possible one after another
  color_prompt "Want to watch another anime? [Y/n]"
  read ans_another
  case $ans_another in
    ""|"y"|"Y")
      watch ;;
    "n"|"N")
      color_prompt "Exiting"
      break ;;
  esac
done
